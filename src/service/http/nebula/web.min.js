import{neb}from"./dist/web/main.js";import{Nebula,count,sum,min,max,avg,tree,p10,p25,p50,p75,p90,p99,p99_9,p99_99}from"./__/sdk.min.js";import{Charts}from"./c/charts.min.js";const time=neb.time,ds=neb.d3.select,$$=e=>$(e).val();let json=[],fpcs,fpce;const timeCol="_time_",windowCol="_window_",charts=new Charts,nebula=new Nebula,formatTime=charts.formatTime,chartId="#show",fieldsId="fields",fieldsRef=`#${fieldsId}`,tablesId="#tables",startId="#start",endId="#end",displayId="#display",NoRollup=-1,msg=text=>ds("#qr").text(text);let filters,$sdc=null;const field=(c,m)=>{const valid=m in neb.Rollup;return{M:valid?neb.Rollup[m]:NoRollup,C:c,T:valid?`${m.toLowerCase()}(${c})`:c}},onTableState=(state,stats,callback)=>{const bc=state.bc,rc=Math.round(state.rc/1e4)/100,ms=Math.round(state.ms/1e7)/100,mints=formatTime(1e3*state.mt),maxts=formatTime(1e3*state.xt+1);stats.text(`[Blocks: ${bc}, Rows: ${rc}M, Mem: ${ms}GB, Min T: ${mints}, Max T: ${maxts}]`),fpcs=neb.fp($(startId),{enableTime:!0,allowInput:!0,clickOpens:!1,dateFormat:"Y-m-d H:i:S",defaultDate:mints,minDate:mints,maxDate:maxts}),$("#startc").on("click",()=>{fpcs.open()}),fpce=neb.fp($(endId),{enableTime:!0,allowInput:!0,clickOpens:!1,dateFormat:"Y-m-d H:i:S",defaultDate:maxts,minDate:mints,maxDate:maxts}),$("#endc").on("click",()=>{fpce.open()});const strColumns=(state.dl||[]).filter(v=>v!==timeCol),numColumns=(state.ml||[]).filter(v=>v!==timeCol),allColumns=strColumns.concat(numColumns),all=[];allColumns.map(e=>all.push(field(e)));for(let r in neb.Rollup){if("COUNT"===r){all.push(field(all[0].C,r));continue}let targetColumns=numColumns;"TREEMERGE"===r&&(targetColumns=strColumns),targetColumns.map(e=>all.push(field(e,r)))}$("#dwrapper").html(`<select id="${fieldsId}" multiple></select>`),ds(fieldsRef).html("").selectAll("option").data(all).enter().append("option").text(d=>d.T).attr("value",d=>`${JSON.stringify(d)}`),$sdc=$(fieldsRef).selectize({plugins:["restore_on_backspace","remove_button"],persist:!1}),ds(displayId).html("").selectAll("option").data(Object.keys(neb.DisplayType)).enter().append("option").text(k=>k.toLowerCase()).attr("value",k=>neb.DisplayType[k]),ds("#ob").html("").selectAll("option").data(Object.keys(neb.OrderType)).enter().append("option").text(k=>k.toLowerCase()).attr("value",k=>neb.OrderType[k]),callback&&callback(allColumns)},initTable=(table,callback)=>{const stats=ds("#stats");$.ajax({url:"/?api=state&start=0&end=0&table="+encodeURIComponent(table)}).fail(err=>{stats.text("Error: "+err)}).done(data=>{onTableState(data,stats,callback)})},checkRequest=state=>{if(!state.start||!state.end)return!0;const display=state.display;if(display==neb.DisplayType.TIMELINE){const windowSize=state.window;if(windowSize>0){const rangeSeconds=(state.end-state.start)/1e3,buckets=rangeSeconds/windowSize;if(buckets>1e3)return msg(`Too many data points to return ${buckets}, please increase window granularity.`),!0}}return display==neb.DisplayType.SAMPLES&&0==state.keys.length&&(msg("Please specify dimensions for samples"),!0)},hash=v=>(v&&(window.location.hash=v),window.location.hash),build=s=>{s&&ds(displayId).property("value",s.display);const keys=[],metrics=[];$$(fieldsRef).map(e=>{const f=JSON.parse(e);f.M===NoRollup?keys.push(f.C):metrics.push(f)});const state=s||{table:$$(tablesId),start:$$(startId),end:$$(endId),filter:filters.expr(),keys:keys,window:$$("#window"),display:$$(displayId),metrics:metrics,sort:$$("#ob"),limit:$$("#limit")};state.start&&state.end?hash("#"+encodeURIComponent(JSON.stringify(state))):alert("please enter start and end time")};let timer=null,timer2=null;const clsTimer=()=>{timer&&clearInterval(timer),timer2&&clearTimeout(timer2)},restore=()=>{clsTimer();const state=url2state(),set=(N,V)=>ds(N).property("value",V);let table=state.table,found=!1,first=null;$(`${tablesId} option`).each((t,v)=>{first=first||v.value,v.value===table&&(found=!0)}),found||(timer=animate(`preparing table ${table} `),timer2=setTimeout(()=>{location.reload()},3e3),table=first),table&&(set(tablesId,table),initTable(table,cols=>{set(startId,state.start),set(endId,state.end),set("#window",state.window),set(displayId,state.display),set("#ob",state.sort),set("#limit",state.limit);const fields=[];(state.keys||[]).map(e=>fields.push(JSON.stringify(field(e)))),(state.metrics||[]).map(e=>fields.push(JSON.stringify(e))),$sdc&&fields.length>0&&$sdc[0].selectize.setValue(fields);const om={EQ:"=",NEQ:"!=",MORE:">",LESS:"<",LIKE:"like",ILIKE:"ilike"},ops={};for(var k in neb.Operation)ops[neb.Operation[k]]=om[k];filters=new neb.Constraints(!1,"filters",cols,ops,state.filter),state.code&&state.code.length>0&&(editor.setValue(state.code),ide()),execute(state)}))},onQueryResult=(state,r)=>{if(r.error)return void msg(`[query: error=${r.error}, latency=${r.duration} ms]`);if(msg(`[query: latency=${r.duration}ms, scan=${r.rows_scan}, blocks=${r.blocks_scan}, rows=${r.rows_ret}]`),json=JSON.parse(atob(r.data)),ds("#table_head").html(""),ds("#table_content").html(""),0==json.length)return void $("#show").html("<b>NO RESULTS.</b>");const draw=()=>{const display=+state.display;if(display!=+$$(displayId))return;if(display==neb.DisplayType.SAMPLES||display==neb.DisplayType.TABLE)return void charts.displayTable(chartId,json);const keys=state.keys.slice(),data=json.slice(),metrics=[];for(const key in data[0])keys.includes(key)||key==timeCol||key==windowCol||metrics.push(key);if(keys.length>1){const con=" - ",combinedCol=keys.join(con);data.forEach(row=>{row[combinedCol]=keys.map(e=>row[e]).join(con)}),keys.length=0,keys.push(combinedCol)}switch(display){case neb.DisplayType.TIMELINE:const beginMs=1e3*time.seconds(state.start);charts.displayTimeline(chartId,data,keys,metrics,windowCol,beginMs);break;case neb.DisplayType.BAR:charts.displayBar(chartId,data,keys,metrics);break;case neb.DisplayType.PIE:charts.displayPie(chartId,data,keys,metrics);break;case neb.DisplayType.LINE:charts.displayLine(chartId,data,keys,metrics);break;case neb.DisplayType.FLAME:charts.displayFlame(chartId,data,keys,metrics)}};draw();var resizeTimer=void 0;$(window).on("resize",()=>{clearTimeout(resizeTimer),resizeTimer=setTimeout(draw,200)})},url2state=()=>{const input=decodeURIComponent((hash()||`#${$$(tablesId)}`).substr(1));let state={table:input};try{state=JSON.parse(input)}catch{}return state};let dots=0;const animate=(prefix,interval)=>setInterval(()=>{dots=(dots+1)%50,msg(`${prefix}${".".repeat(dots)}`)},interval||200),execute=state=>{state||(state=url2state()),checkRequest(state)||(timer=animate("soaring in nebula "),$.ajax({url:"/?api=query&start=0&end=0&query="+JSON.stringify(state)}).fail(err=>{clsTimer(),msg(`Error: ${err}`)}).done(data=>{clsTimer(),onQueryResult(state,data)}))};ds("#soar").on("click",build);const editor=CodeMirror.fromTextArea($("#code").get(0),{lineNumbers:!1,lineWrapping:!0,styleActiveLine:!0,matchBrackets:!0,mode:"javascript",theme:"dracula"}),ide=()=>{const c_on="tap-on",c_off="tap-off",on=$(".tap-on"),off=$(".tap-off");on.removeClass(c_on).addClass(c_off),off.removeClass(c_off).addClass(c_on),setTimeout(()=>editor.refresh(),5)};ds("#ui").on("click",ide);const exec=()=>{const code=editor.getValue();nebula.reset();try{eval(code)}catch(e){return void msg(`Code Error: ${e.message}`)}const error=nebula.validate();if(error)return void msg(`Validation Error: ${error}`);const state=nebula.build();state.code=code,build(state)};ds("#exec").on("click",exec),window.onhashchange=function(){restore()};const onTableList=tables=>{if(tables&&tables.length>0){const options=ds(tablesId).selectAll("option").data(tables.sort()).enter().append("option");return options.text(d=>d).attr("value",d=>d),void restore()}msg("Nebula is down: can not fetch tables")};$(()=>{const stats=ds("#stats");$.ajax({url:"/?api=tables&start=0&end=0"}).fail(err=>{stats.text("Error: "+err)}).done(data=>{onTableList(data)}),$(tablesId).change(()=>{hash($(tablesId).val()),restore()}),$.ajax({url:"/?api=user"}).done(data=>{ds("#user").text(data.auth?data.user:"unauth")})});