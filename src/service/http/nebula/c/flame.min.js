export class Flame{constructor(id,stack,reverse){const fontSize=16,font="1rem Segoe UI",paddingV=10,paddingH=5,frameH=20;this.reverse=reverse||!1,this.canvas=document.getElementById(id),this.ctx=this.canvas.getContext("2d"),this.maxLevel=1;{const ratio=devicePixelRatio||1,canvasWidth=this.canvas.offsetWidth,canvasHeight=this.canvas.offsetHeight;this.canvas.style.width=canvasWidth+"px",this.canvas.width=canvasWidth*ratio,this.canvas.height=canvasHeight*ratio,this.ctx.scale(ratio,ratio),this.ctx.font=font,this.ratio=ratio}this.palette=[[9662683,20,30,30],[9662683,20,30,10],[9662683,20,10,30],[9662683,20,20,10],[9662683,20,10,10]],this.getColor=p=>{const v=Math.random();return"#"+(p[0]+(p[1]*v<<16|p[2]*v<<8|p[3]*v)).toString(16)},this.color=name=>{let type=4;return name.endsWith("_[j]")?type=0:name.endsWith("_[i]")?type=1:name.endsWith("_[k]")?type=2:(name.includes("::")||name.startsWith("-[")||name.startsWith("+["))&&(type=3),this.getColor(this.palette[type])},this.draw=frame=>{const name=frame.name||"all",width=frame.width,c=frame.coord;if(c.x<this.canvas.offsetWidth&&width>1){const y=this.reverse?this.height-c.y:c.y;if(this.ctx.fillStyle=this.color(name),this.ctx.fillRect(c.x,y,width,20),width>=21){const chars=Math.floor(width/7),title=name.length<=chars?name:name.substring(0,chars-2)+"..";this.ctx.fillStyle="#000000",this.ctx.font=font,this.ctx.fillText(title,c.x+3,y+16,width-6)}}},this.touch=(frame,show)=>{frame.show=show;const children=frame.children||[],level=frame.level+1;return show&&level>this.maxLevel&&(this.maxLevel=level),children.forEach(c=>{c.show=show,c.parent=frame,c.level=level}),children},this.mark=(frame,root)=>{if(root){const queue=[...this.touch(frame,!1)];for(;queue.length>0;){if(queue.includes(root)){let p=root;for(;p;)p.show=!0,p=p.parent;break}queue.push(...this.touch(queue.shift(),!1))}}const queue=[];for(queue.push(...this.touch(root||frame,!0));queue.length>0;)queue.push(...this.touch(queue.shift(),!0))},this.visit=frame=>{if(!frame.show)return;this.draw(frame);const childY=frame.coord.y+20+2,children=(frame.children||[]).filter(e=>e.show),total=children.reduce((a,b)=>a+b.value,0);let lastX=frame.coord.x;const endX=lastX+frame.width;children.forEach(c=>{const pct=c.value/total;c.width=Math.floor(pct*frame.width);const overflow=lastX+c.width-endX;overflow>0&&(c.width-=overflow),c.coord={x:lastX,y:childY},lastX+=c.width+1,this.visit(c)})},this.paint=root=>{this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this.maxLevel=0,this.mark(stack,root),this.height=22*this.maxLevel,this.visit(stack,root)},stack.width=this.canvas.offsetWidth-10,stack.level=0,stack.coord={x:5,y:10},this.paint(),this.find=(frame,coord)=>{const c=frame.coord,y=this.reverse?this.height-c.y:c.y;if(frame.show&&coord.y>=y&&coord.y<=y+20&&coord.x>=c.x&&coord.x<=c.x+frame.width)return frame;const children=frame.children||[];for(let i=0;i<children.length;++i){const found=this.find(children[i],coord);if(found)return found}return null},this.canvas.onmousemove=event=>{const c=this.canvas,frame=this.find(stack,{x:event.clientX-c.offsetLeft,y:event.clientY-c.offsetTop});if(frame){c.style.cursor="pointer";const ratio=(100*frame.width/stack.width).toPrecision(3);return c.title=`name: ${frame.name}, value: ${frame.value}, ratio: ${ratio}%`,void(c.onclick=()=>{this.paint(frame)})}this.canvas.onmouseout()},this.canvas.onmouseout=()=>{const c=this.canvas;c.title="",c.style.cursor="",c.onclick=""}}}