import{neb}from"/dist/web/main.js";const d3=neb.d3,ds=neb.d3.select,color=i=>d3.schemeCategory10[i%10],symbols=["circle","diamond","square","triangle-up","triangle-down","cross"],symbol=i=>d3.symbol().size(81).type(symbols[i%symbols.length]),isTime=c=>"_time_"===c,pad2=v=>`${v}`.padStart(2,0),localTime=unix_ms=>new Date(unix_ms).toLocaleString(),isoTime=unix_ms=>new Date(unix_ms).toISOString();export class Charts{constructor(){this.formatTime=unix_ms=>{const date=new Date(unix_ms),y=date.getUTCFullYear(),m=pad2(date.getUTCMonth()+1),d=pad2(date.getUTCDate()),h=pad2(date.getUTCHours()),mi=pad2(date.getUTCMinutes()),s=pad2(date.getUTCSeconds());return`${y}-${m}-${d} ${h}:${mi}:${s}`},this.legend=(svg,px,py,names,width=0,vertical=!0)=>{const span=width>0&&names.length>0?width/names.length:60,legend=svg.selectAll("g.legend").data(names).enter().append("svg:g").attr("class","legend").attr("transform",(d,i)=>vertical?`translate(${px}, ${py+20*i+20})`:`translate(${px+i*span}, ${py})`);legend.append("svg:rect").attr("width",15).attr("height",15).attr("fill",(d,i)=>color(i)),legend.append("svg:text").attr("text-anchor","left").attr("x",18).attr("y",15).text((d,i)=>d)},this.displayTable=json=>{if(json.length>0){const area=ds("#show");area.html("");const tb=area.append("table");tb.append("thead").append("tr").attr("id","table_head"),tb.append("tbody").attr("id","table_content");const keys=Object.keys(json[0]),width=Math.round(100/keys.length);ds("#table_head").selectAll("th").data(keys).enter().append("th").attr("width",`${width}%`).text(d=>isTime(d)?"[time]":d),ds("#table_content").selectAll("tr").data(json).enter().append("tr").selectAll("td").data(row=>keys.map(column=>({column:column,value:isTime(column)?this.formatTime(1e3*row[column]):row[column]}))).enter().append("td").text(d=>d.value)}},this.displayBar=(json,key,value)=>{const area=ds("#show");area.html("");const margin_top=20,margin_right=20,margin_bottom=70,margin_left=40,width=area.node().scrollWidth-margin_left-margin_right,height=600,x=d3.scaleBand().rangeRound([0,width]).paddingInner([.2]).paddingOuter([.4]).align([.5]),y=d3.scaleLinear().range([600,0]),xAxis=d3.axisBottom(x),yAxis=d3.axisLeft(y).ticks(10),svg=area.append("svg").attr("width",width+margin_left+margin_right).attr("height",600+margin_top+margin_bottom).append("g").attr("transform",`translate(${margin_left},${margin_top})`);x.domain(json.map(row=>row[key])),y.domain([0,d3.max(json,row=>row[value])]),svg.append("g").attr("class","x axis").attr("transform","translate(0, 600)").call(xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.55em").attr("transform","rotate(-45)"),svg.append("g").attr("class","y axis").call(yAxis).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Value ($)"),svg.selectAll("bar").data(json).enter().append("rect").style("fill","steelblue").attr("x",row=>x(row[key])).attr("y",row=>y(row[value])).attr("width",x.bandwidth()).attr("height",row=>600-y(row[value]))},this.displayPie=(json,key,value)=>{const area=ds("#show");area.html(""),json.sort((a,b)=>b[value]-a[value]);const w=area.node().scrollWidth,h=400,r=Math.min(w,h)/2,vis=area.append("svg:svg").data([json]).attr("width",w).attr("height",h).append("svg:g").attr("transform",`translate(${w/2},200)`),arc=d3.arc().outerRadius(r-10).innerRadius(0),pie=d3.pie().value(row=>row[value]),arcs=vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class","slice");arcs.append("svg:path").attr("fill",(d,i)=>color(i)).attr("d",arc),this.legend(vis,r+100,-r,json.map(e=>e[key]))},this.displayLine=(json,key,value)=>{const area=ds("#show");area.html("");const margin_top=20,margin_right=60,margin_bottom=20,margin_left=60,width=area.node().scrollWidth-margin_left-margin_right,height=400-margin_top-margin_bottom;json.sort((a,b)=>a[key]<b[key]?-1:1);const x=d3.scaleBand().range([0,width]).domain(json.map(e=>e[key])),y=d3.scaleBand().range([0,height]).domain(json.map(e=>+e[value]).sort((a,b)=>b-a));var line=d3.line().x(d=>x(d[key])).y(d=>y(d[value])),svg=area.append("svg").attr("width",width+margin_left+margin_right).attr("height",height+margin_top+margin_bottom).append("g").attr("transform",`translate(${margin_left}, ${margin_top})`);svg.append("path").data([json]).attr("class","line").attr("d",line),svg.append("g").attr("transform",`translate(0, ${height})`).call(d3.axisBottom(x)),svg.append("g").call(d3.axisLeft(y))},this.displayFlame=(data,group,key)=>{if(data&&data.length){const margin={top:20,right:60,bottom:20,left:60},area=ds("#show");area.html("");const width=area.node().scrollWidth-margin.left-margin.right;for(var i=0;i<data.length;++i){const title=group?data[i][group]:null,blob=JSON.parse(data[i][key]),flame=neb.flamegraph().width(width).sort(!0).minFrameSize(1);title&&flame.title(title),area.append("div").datum(blob).call(flame)}}},this.displayTimeline=(data,key,value,start)=>{const area=ds("#show");area.html("");const margin_top=20,margin_right=60,margin_bottom=20,margin_left=60,width=area.node().scrollWidth-margin_left-margin_right,height=400-margin_top-margin_bottom;var svg=area.append("svg").attr("width",width+margin_left+margin_right).attr("height",height+margin_top+margin_bottom).append("g").attr("transform",`translate(${margin_left}, ${margin_top})`);const xmin=[],xmax=[],ymin=[],ymax=[],kds={};for(var k in data){const kd=data[k].sort((a,b)=>a[key]-b[key]).map(e=>{let obj={};return obj[key]=1e3*e[key]+start,obj[value]=+e[value],obj});kds[k]=kd,xmin.push(d3.min(kd,d=>d[key])),xmax.push(d3.max(kd,d=>d[key])),ymin.push(d3.min(kd,d=>d[value])),ymax.push(d3.max(kd,d=>d[value]))}const x=d3.scaleTime().range([0,width]).domain([d3.min(xmin),d3.max(xmax)]),y=d3.scaleLinear().range([height,0]).domain([d3.min(ymin),d3.max(ymax)]);var line=d3.line().x(d=>x(new Date(d[key]))).y(d=>y(d[value])).curve(d3.curveMonotoneX),tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);let idx=0;for(var k in kds){const kd=kds[k];if(0==kd.length)continue;svg.append("path").datum(kd).attr("class","line").attr("stroke",color(idx++)).attr("d",line);const samples=[],MAX_BASE=10,skip=Math.max(Math.round(kd.length/MAX_BASE),1);for(var i=0;i<kd.length;i+=skip)samples.push(kd[i]);svg.selectAll(`g-${idx}`).data(samples).enter().append("circle").attr("class","dot").attr("cx",(d,i)=>x(new Date(d[key]))).attr("cy",d=>y(d[value])).attr("r",5).on("mouseover",d=>{tooltip.transition().duration(200).style("opacity",.8),tooltip.html(`T: ${localTime(d[key])}<br/>V: ${d[value]}`).style("left",`${d3.event.pageX}px`).style("top",`${d3.event.pageY}px`)}).on("mouseout",d=>{tooltip.transition().duration(500).style("opacity",0)})}this.legend(svg,margin_left,0,Object.keys(kds),width,!1),svg.append("g").attr("transform",`translate(0, ${height})`).call(d3.axisBottom(x)),svg.append("g").call(d3.axisLeft(y))}}}